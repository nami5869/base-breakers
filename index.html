<script>
(async () => {
  // --- Safe status helper ---
  const statusEl = document.getElementById('status');
  const say = (msg) => { if (statusEl) statusEl.textContent = msg; };

  // Make sure the dashboard shows even if anything fails early
  document.getElementById('dashboard')?.style.setProperty('display', 'flex');

  // Try loading the SDK with multiple strategies
  let sdk = null;
  try {
    // Preferred: ESM import
    const m = await import('https://esm.sh/@farcaster/miniapp-sdk');
    sdk = m?.sdk ?? null;
  } catch (e) {
    console.error('ESM import failed:', e);
  }

  // Fallback: bundled UMD
  if (!sdk) {
    try {
      await new Promise((resolve, reject) => {
        const s = document.createElement('script');
        s.src = 'https://esm.sh/@farcaster/miniapp-sdk?bundle';
        s.defer = true;
        s.onload = resolve;
        s.onerror = reject;
        document.head.appendChild(s);
      });
      // Some bundlers attach to window.sdk; if not, skip
      sdk = window.sdk || null;
    } catch (e) {
      console.error('Bundle fallback failed:', e);
    }
  }

  if (!sdk) {
    say('Could not load Farcaster Mini App SDK.');
    // Let the user play *without* the paywall so the app is never blank
    // Remove payment gate by wiring Play to start immediately:
    const btn = document.getElementById('dashStart');
    if (btn) btn.onclick = () => {
      document.getElementById('dashboard').style.display = 'none';
      document.getElementById('hud').style.display = 'flex';
      window.startLoop?.();
    };
    return;
  }

  // Ready signal (required)
  try { sdk.actions.ready(); } catch {}

  // ==== Your original wallet + payment wiring (guarded) ====

  const RECIPIENT = '0x8C6e7978ee3324196ea7e478830fF9cD4AD7D507';
  const AMOUNT_ETH = '0.00001';
  const USE_BASE_SEPOLIA = false;

  const BASE_MAINNET = {
    chainId: '0x2105',
    chainName: 'Base',
    rpcUrls: ['https://mainnet.base.org'],
    nativeCurrency: { name: 'Ether', symbol: 'ETH', decimals: 18 },
    blockExplorerUrls: ['https://basescan.org']
  };
  const BASE_SEPOLIA = {
    chainId: '0x14a34',
    chainName: 'Base Sepolia',
    rpcUrls: ['https://sepolia.base.org'],
    nativeCurrency: { name: 'Sepolia Ether', symbol: 'ETH', decimals: 18 },
    blockExplorerUrls: ['https://sepolia.basescan.org']
  };
  const TARGET = USE_BASE_SEPOLIA ? BASE_SEPOLIA : BASE_MAINNET;

  const dashBest = document.getElementById('dashBest');
  const dashGames = document.getElementById('dashGames');
  const dashLast = document.getElementById('dashLast');

  // Player name from Farcaster (optional)
  window.__PLAYER_NAME__='@Player';
  window.__WALLET_SHORT__='';

  try {
    const viewer = await sdk.viewer.getUser();
    if (viewer?.username) {
      window.__PLAYER_NAME__ = '@' + viewer.username;
      const u = document.getElementById('dashUser');
      if (u) u.textContent = window.__PLAYER_NAME__;
    }
  } catch (e) {
    console.warn('viewer.getUser failed', e);
  }

  function refreshDashboard(){
    const best = Number(localStorage.getItem('baseBest')||localStorage.getItem('astroBest')||0);
    const games = Number(localStorage.getItem('baseGames')||localStorage.getItem('astroGames')||0);
    const last = Number(localStorage.getItem('baseLast')||localStorage.getItem('astroLast')||0);
    if (dashBest) dashBest.textContent = best;
    if (dashGames) dashGames.textContent = games;
    if (dashLast) dashLast.textContent = last;
  }
  refreshDashboard();

  function parseEther(x){
    const [w,f='']=String(x).split('.');
    const frac=(f+'0'.repeat(18)).slice(0,18);
    return '0x'+(BigInt(w)*10n**18n+BigInt(frac)).toString(16);
  }

  async function getProvider(){
    try { const p = await sdk.wallet.getEthereumProvider(); if (p) return p; } catch {}
    return window.ethereum ?? null;
  }

  async function ensureChain(p, chain){
    const current = (await p.request({method:'eth_chainId'}))?.toLowerCase();
    if (current === chain.chainId.toLowerCase()) return;
    try {
      await p.request({ method:'wallet_switchEthereumChain', params:[{ chainId: chain.chainId }] });
    } catch (e) {
      if (e?.code === 4902) {
        await p.request({ method:'wallet_addEthereumChain', params:[ chain ] });
        await p.request({ method:'wallet_switchEthereumChain', params:[{ chainId: chain.chainId }] });
      } else {
        throw e;
      }
    }
  }

  async function requiredPayment(){
    const statusEl = document.getElementById('status');
    const say = (m) => { if (statusEl) statusEl.textContent = m; };
    say('Connecting wallet…');

    const provider = await getProvider();
    if (!provider) { say('No wallet detected.'); throw new Error('NO_PROVIDER'); }

    const [from] = await provider.request({method:'eth_requestAccounts'});
    window.__WALLET_SHORT__ = from ? `${from.slice(0,6)}…${from.slice(-4)}` : '';

    await ensureChain(provider, TARGET);

    say(`Sending ${AMOUNT_ETH} ETH…`);
    const hash = await provider.request({
      method:'eth_sendTransaction',
      params:[{ from, to:RECIPIENT, value:parseEther(AMOUNT_ETH) }]
    });

    const explorer = (TARGET.blockExplorerUrls && TARGET.blockExplorerUrls[0]) || '';
    if (statusEl) statusEl.innerHTML = `TX sent! ${explorer ? `<a target="_blank" href="${explorer}/tx/${hash}">View TX</a>` : ''}`;
    return hash;
  }

  function showGame(){
    document.getElementById('dashboard').style.display='none';
    document.getElementById('hud').style.display='flex';
    window.startLoop?.();
  }

  async function payThenStart(btn){
    try {
      btn.disabled = true;
      await requiredPayment();
      const overDlg = document.getElementById('over');
      if (overDlg && overDlg.open) overDlg.close();
      showGame();
    } catch (e) {
      say('Payment cancelled or failed.');
      console.error(e);
    } finally {
      btn.disabled = false;
    }
  }

  // Wire buttons
  document.getElementById('dashStart')?.addEventListener('click', (e)=>{
    e.preventDefault();
    payThenStart(e.currentTarget);
  });
  document.getElementById('dashLeaderboard')?.addEventListener('click', ()=>{
    window.showLeaderboard?.();
  });
})();
</script>
